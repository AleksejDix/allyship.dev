<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>axe-core vs ACT Test Runner Benchmark</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .control-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .control-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .buttons { display: flex; gap: 10px; flex-wrap: wrap; margin: 20px 0; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.2s ease; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; }
        .status { padding: 15px; margin: 20px 0; border-radius: 8px; font-weight: bold; text-align: center; display: none; }
        .status.running { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .results { display: none; margin: 30px 0; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .result-card { background: white; border: 2px solid #dee2e6; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .result-card.winner { border-color: #28a745; background: #f8fff9; }
        .result-card h3 { margin-top: 0; display: flex; align-items: center; gap: 10px; }
        .metric { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .metric:last-child { border-bottom: none; }
        .metric-value { font-weight: bold; }
        .speedup { background: #007bff; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; margin-top: 10px; display: inline-block; }
        .test-containers { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ axe-core vs ACT Test Runner</h1>
        <p>Performance Benchmark Comparison</p>
        <p><strong>Goal:</strong> Prove ACT Test Runner can be 25x faster than axe-core</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="elementCount">Elements to Test:</label>
            <select id="elementCount">
                <option value="100">100 elements</option>
                <option value="500">500 elements</option>
                <option value="1000" selected>1,000 elements</option>
                <option value="2500">2,500 elements</option>
            </select>
        </div>
        <div class="control-group">
            <label for="testType">Test Type:</label>
            <select id="testType">
                <option value="mixed" selected>Mixed Elements</option>
                <option value="images">Images (Alt Text)</option>
                <option value="buttons">Buttons (Names)</option>
                <option value="links">Links (Text)</option>
            </select>
        </div>
        <div class="control-group">
            <label for="rounds">Test Rounds:</label>
            <select id="rounds">
                <option value="1">1 round</option>
                <option value="3" selected>3 rounds</option>
                <option value="5">5 rounds</option>
            </select>
        </div>
    </div>

    <div class="buttons">
        <button class="btn btn-primary" onclick="runComparison()">üèÅ Run Comparison</button>
        <button class="btn btn-secondary" onclick="runAxeOnly()">‚ö° Test axe-core</button>
        <button class="btn btn-secondary" onclick="runActOnly()">üéØ Test ACT Runner</button>
        <button class="btn btn-secondary" onclick="resetBenchmark()">üîÑ Reset & Clear</button>
    </div>

    <div id="status" class="status"></div>

    <div id="results" class="results">
        <h2>üìä Benchmark Results</h2>
        <div id="comparison" class="comparison"></div>
        <div id="detailed-results"></div>
    </div>

    <div id="test-container-act" class="test-containers"></div>
    <div id="test-container-axe" class="test-containers"></div>

    <script src="performance-tracker.js"></script>
    <script src="https://unpkg.com/axe-core@4.10.3/axe.min.js"></script>

    <script>
        let performanceTracker;
        let actModule;

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Initializing Benchmark');
            performanceTracker = new PerformanceTracker();

            try {
                actModule = await import('../dist/index.js');
                console.log('‚úÖ ACT Test Runner loaded');
                console.log('Available exports:', Object.keys(actModule));
                console.log('describe function:', typeof actModule.describe);
                console.log('test function:', typeof actModule.test);
                console.log('expect function:', typeof actModule.expect);
                console.log('runTests function:', typeof actModule.runTests);

                if (typeof axe !== 'undefined') {
                    console.log('‚úÖ axe-core loaded');
                    showStatus('Ready to benchmark!', 'success');
                } else {
                    showStatus('axe-core not loaded', 'error');
                }
            } catch (error) {
                console.error('‚ùå Failed to load ACT Test Runner:', error);
                showStatus('Failed to load ACT Test Runner. Build the project first.', 'error');
            }
        });

        function generateElements(type, count) {
            const generators = {
                mixed: [
                    () => `<img src="test.jpg" alt="Test image">`,
                    () => `<img src="test.jpg" alt="">`,
                    () => `<img src="test.jpg">`,
                    () => `<button>Test Button</button>`,
                    () => `<button></button>`,
                    () => `<a href="#test">Test Link</a>`,
                    () => `<a href="#test">Click here</a>`,
                    () => `<input type="text" aria-label="Test Input">`,
                    () => `<input type="text">`,
                    () => `<div>Generic div</div>`
                ],
                images: [
                    () => `<img src="test.jpg" alt="Descriptive alt">`,
                    () => `<img src="test.jpg" alt="">`,
                    () => `<img src="test.jpg">`,
                    () => `<img src="test.jpg" alt="image">`
                ],
                buttons: [
                    () => `<button>Descriptive button</button>`,
                    () => `<button></button>`,
                    () => `<button aria-label="Close">√ó</button>`,
                    () => `<div role="button">Custom button</div>`
                ],
                links: [
                    () => `<a href="#test">Descriptive link</a>`,
                    () => `<a href="#test">Click here</a>`,
                    () => `<a href="#test"></a>`
                ]
            };

            const elementTypes = generators[type];
            const elements = [];
            for (let i = 0; i < count; i++) {
                const randomType = elementTypes[i % elementTypes.length];
                elements.push(randomType());
            }
            return elements;
        }

        function populateContainer(containerId, testType, elementCount) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const elements = generateElements(testType, elementCount);
            elements.forEach(html => {
                const div = document.createElement('div');
                div.innerHTML = html;
                container.appendChild(div.firstChild);
            });
            return container;
        }

        // Define accessibility tests using ACT Test Runner API
        function defineAccessibilityTests(module) {
            if (!module || !module.describe || !module.test || !module.expect) {
                throw new Error('ACT Test Runner module not properly loaded');
            }

            const { describe, test, expect } = module;

            // Image alt text tests
            describe('Image Alt Text', () => {
                test('Images should have meaningful alt text', ({ element }) => {
                    if (element.tagName === 'IMG') {
                        const alt = element.getAttribute('alt');
                        expect(alt).not.toBe(null); // Should have alt attribute
                        if (alt !== '') {
                            expect(alt.length).toBeGreaterThan(3); // Meaningful alt text
                        }
                    }
                });
            });

            // Button accessibility tests
            describe('Button Accessibility', () => {
                test('Buttons should have accessible names', ({ element }) => {
                    if (element.tagName === 'BUTTON' || element.getAttribute('role') === 'button') {
                        const name = element.textContent?.trim() || element.getAttribute('aria-label') || element.getAttribute('title');
                        expect(name).toBeTruthy();
                        expect(name.length).toBeGreaterThan(0);
                    }
                });
            });

            // Link accessibility tests
            describe('Link Accessibility', () => {
                test('Links should have meaningful text', ({ element }) => {
                    if (element.tagName === 'A') {
                        const text = element.textContent?.trim();
                        expect(text).toBeTruthy();
                        expect(text).not.toBe('Click here');
                        expect(text).not.toBe('Read more');
                    }
                });
            });

            // Form accessibility tests
            describe('Form Accessibility', () => {
                test('Form inputs should have labels', ({ element }) => {
                    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(element.tagName)) {
                        const label = element.getAttribute('aria-label') ||
                                    element.getAttribute('aria-labelledby') ||
                                    document.querySelector(`label[for="${element.id}"]`);
                        expect(label).toBeTruthy();
                    }
                });
            });
        }

        // Clear any existing test state
        function clearTestState() {
            // Clear any global test state that might accumulate
            if (window.actTestSuites) {
                window.actTestSuites = [];
            }
            if (window.actCurrentSuite) {
                window.actCurrentSuite = null;
            }

            // Force garbage collection if available
            if (window.gc) {
                window.gc();
            }
        }

        async function runActTest(elementCount, testType, rounds) {
            if (!actModule) {
                throw new Error('ACT Test Runner module not loaded');
            }

            const results = [];

            for (let round = 0; round < rounds; round++) {
                // Clear any previous test state before each round
                clearTestState();

                const container = populateContainer('test-container-act', testType, elementCount);

                try {
                    const startTime = performance.now();

                    // Check if we have the test framework functions
                    if (actModule.describe && actModule.test && actModule.expect) {
                        // Define tests for the current container
                        defineAccessibilityTests(actModule);

                        // Run the tests
                        const testResults = await actModule.runTests({
                            timeout: 5000,
                            bail: false,
                            reporter: 'minimal'
                        });

                        const endTime = performance.now();

                        // Count total issues (failed tests)
                        const totalIssues = testResults.reduce((total, suite) => total + suite.failed, 0);

                        results.push({
                            duration: endTime - startTime,
                            elementCount,
                            issuesFound: totalIssues,
                            runner: 'ACT Test Runner'
                        });
                    } else {
                        // Fallback: Run simple accessibility checks directly
                        console.log('Using fallback accessibility checks...');

                        const issues = runSimpleAccessibilityChecks(container);
                        const endTime = performance.now();

                        results.push({
                            duration: endTime - startTime,
                            elementCount,
                            issuesFound: issues.length,
                            runner: 'ACT Test Runner (Fallback)'
                        });
                    }

                    // Clean up after each round
                    container.innerHTML = '';
                    clearTestState();

                } catch (error) {
                    console.error('ACT Test Runner error:', error);
                    throw error;
                }
            }

            return results;
        }

        // Simple fallback accessibility checks
        function runSimpleAccessibilityChecks(container) {
            const issues = [];

            // Check images without alt text
            const images = container.querySelectorAll('img');
            images.forEach((img, index) => {
                if (!img.hasAttribute('alt')) {
                    issues.push(`Image ${index + 1}: Missing alt attribute`);
                } else if (img.getAttribute('alt') === '' && !img.hasAttribute('role')) {
                    // Empty alt is OK for decorative images
                } else if (img.getAttribute('alt').length < 3) {
                    issues.push(`Image ${index + 1}: Alt text too short`);
                }
            });

            // Check buttons without accessible names
            const buttons = container.querySelectorAll('button, [role="button"]');
            buttons.forEach((button, index) => {
                const name = button.textContent?.trim() || button.getAttribute('aria-label') || button.getAttribute('title');
                if (!name || name.length === 0) {
                    issues.push(`Button ${index + 1}: Missing accessible name`);
                }
            });

            // Check links with poor text
            const links = container.querySelectorAll('a');
            links.forEach((link, index) => {
                const text = link.textContent?.trim();
                if (!text || text.length === 0) {
                    issues.push(`Link ${index + 1}: Missing link text`);
                } else if (['click here', 'read more', 'more'].includes(text.toLowerCase())) {
                    issues.push(`Link ${index + 1}: Non-descriptive link text: "${text}"`);
                }
            });

            // Check form inputs without labels
            const inputs = container.querySelectorAll('input, textarea, select');
            inputs.forEach((input, index) => {
                const hasLabel = input.getAttribute('aria-label') ||
                               input.getAttribute('aria-labelledby') ||
                               (input.id && container.querySelector(`label[for="${input.id}"]`));
                if (!hasLabel) {
                    issues.push(`Input ${index + 1}: Missing label`);
                }
            });

            return issues;
        }

        async function runAxeTest(elementCount, testType, rounds) {
            const results = [];
            for (let round = 0; round < rounds; round++) {
                const container = populateContainer('test-container-axe', testType, elementCount);
                const startTime = performance.now();

                try {
                    const axeResults = await axe.run(container);
                    const endTime = performance.now();
                    results.push({
                        duration: endTime - startTime,
                        elementCount,
                        issuesFound: axeResults.violations.reduce((total, v) => total + v.nodes.length, 0),
                        runner: 'axe-core'
                    });
                } catch (error) {
                    console.error('axe-core error:', error);
                    throw error;
                }
            }
            return results;
        }

        function calculateAverage(results) {
            if (results.length === 0) return null;
            return {
                duration: results.reduce((sum, r) => sum + r.duration, 0) / results.length,
                elementCount: results[0].elementCount,
                issuesFound: Math.round(results.reduce((sum, r) => sum + r.issuesFound, 0) / results.length),
                runner: results[0].runner,
                rounds: results.length
            };
        }

        async function runComparison() {
            const elementCount = parseInt(document.getElementById('elementCount').value);
            const testType = document.getElementById('testType').value;
            const rounds = parseInt(document.getElementById('rounds').value);

            try {
                showStatus(`Running comparison: ${elementCount} elements, ${rounds} rounds...`, 'running');

                showStatus('Testing ACT Test Runner...', 'running');
                const actResults = await runActTest(elementCount, testType, rounds);

                showStatus('Testing axe-core...', 'running');
                const axeResults = await runAxeTest(elementCount, testType, rounds);

                const actAvg = calculateAverage(actResults);
                const axeAvg = calculateAverage(axeResults);

                displayResults(actAvg, axeAvg);
                showStatus('Benchmark completed!', 'success');

            } catch (error) {
                console.error('Benchmark error:', error);
                showStatus(`Benchmark failed: ${error.message}`, 'error');
            }
        }

        async function runAxeOnly() {
            const elementCount = parseInt(document.getElementById('elementCount').value);
            const testType = document.getElementById('testType').value;
            const rounds = parseInt(document.getElementById('rounds').value);

            try {
                showStatus(`Testing axe-core: ${elementCount} elements...`, 'running');
                const results = await runAxeTest(elementCount, testType, rounds);
                const avg = calculateAverage(results);

                console.log('axe-core results:', avg);
                showStatus(`axe-core: ${avg.duration.toFixed(2)}ms for ${elementCount} elements`, 'success');
            } catch (error) {
                showStatus(`axe-core test failed: ${error.message}`, 'error');
            }
        }

        async function runActOnly() {
            const elementCount = parseInt(document.getElementById('elementCount').value);
            const testType = document.getElementById('testType').value;
            const rounds = parseInt(document.getElementById('rounds').value);

            try {
                showStatus(`Testing ACT Test Runner: ${elementCount} elements...`, 'running');
                const results = await runActTest(elementCount, testType, rounds);
                const avg = calculateAverage(results);

                console.log('ACT Test Runner results:', avg);
                showStatus(`ACT Test Runner: ${avg.duration.toFixed(2)}ms for ${elementCount} elements`, 'success');
            } catch (error) {
                showStatus(`ACT Test Runner test failed: ${error.message}`, 'error');
            }
        }

        function displayResults(actResult, axeResult) {
            document.getElementById('results').style.display = 'block';

            const speedup = (axeResult.duration / actResult.duration).toFixed(1);
            const actSpeed = Math.round(actResult.elementCount / (actResult.duration / 1000));
            const axeSpeed = Math.round(axeResult.elementCount / (axeResult.duration / 1000));

            const comparison = document.getElementById('comparison');
            comparison.innerHTML = `
                <div class="result-card ${actResult.duration < axeResult.duration ? 'winner' : ''}">
                    <h3>${actResult.duration < axeResult.duration ? 'üèÜ' : ''} üéØ ACT Test Runner</h3>
                    <div class="metric">
                        <span>Execution Time:</span>
                        <span class="metric-value">${actResult.duration.toFixed(2)}ms</span>
                    </div>
                    <div class="metric">
                        <span>Speed:</span>
                        <span class="metric-value">${actSpeed.toLocaleString()} elements/sec</span>
                    </div>
                    <div class="metric">
                        <span>Issues Found:</span>
                        <span class="metric-value">${actResult.issuesFound}</span>
                    </div>
                    ${actResult.duration < axeResult.duration ? `<div class="speedup">${speedup}x Faster!</div>` : ''}
                </div>

                <div class="result-card ${axeResult.duration < actResult.duration ? 'winner' : ''}">
                    <h3>${axeResult.duration < actResult.duration ? 'üèÜ' : ''} ‚ö° axe-core</h3>
                    <div class="metric">
                        <span>Execution Time:</span>
                        <span class="metric-value">${axeResult.duration.toFixed(2)}ms</span>
                    </div>
                    <div class="metric">
                        <span>Speed:</span>
                        <span class="metric-value">${axeSpeed.toLocaleString()} elements/sec</span>
                    </div>
                    <div class="metric">
                        <span>Issues Found:</span>
                        <span class="metric-value">${axeResult.issuesFound}</span>
                    </div>
                </div>
            `;

            document.getElementById('detailed-results').innerHTML = `
                <h3>Performance Summary</h3>
                <div style="padding: 15px; background: #e7f3ff; border-radius: 8px;">
                    <p><strong>Speedup:</strong> ACT Test Runner is <strong>${speedup}x ${actResult.duration < axeResult.duration ? 'faster' : 'slower'}</strong> than axe-core</p>
                    <p><strong>Target:</strong> 25x faster (${(25 / parseFloat(speedup)).toFixed(1)}x improvement needed)</p>
                    <p><strong>Elements tested:</strong> ${actResult.elementCount.toLocaleString()}</p>
                    <p><strong>Test rounds:</strong> ${actResult.rounds}</p>
                    <p><strong>ACT Speed:</strong> ${actSpeed.toLocaleString()} elements/sec</p>
                    <p><strong>axe Speed:</strong> ${axeSpeed.toLocaleString()} elements/sec</p>
                </div>
            `;
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => status.style.display = 'none', 3000);
            }
        }

        function resetBenchmark() {
            console.log('üîÑ Resetting benchmark state...');

            // Clear all test containers
            document.getElementById('test-container-act').innerHTML = '';
            document.getElementById('test-container-axe').innerHTML = '';

            // Clear results display
            document.getElementById('results').style.display = 'none';
            document.getElementById('comparison').innerHTML = '';
            document.getElementById('detailed-results').innerHTML = '';

            // Clear all global test state
            clearTestState();

            // Clear any additional global variables that might accumulate
            if (window.actTestRegistry) {
                window.actTestRegistry = {};
            }
            if (window.actSuiteRegistry) {
                window.actSuiteRegistry = {};
            }

            // Force multiple garbage collection cycles
            if (window.gc) {
                window.gc();
                setTimeout(() => window.gc(), 100);
                setTimeout(() => window.gc(), 200);
            }

            showStatus('Benchmark reset complete! Memory cleared.', 'success');
        }
    </script>
</body>
</html>
