name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  NODE_VERSION: '18'
  REGISTRY_URL: 'https://registry.npmjs.org'

jobs:
  # âœ… Code Quality Checks
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'packages/test/package-lock.json'

      - name: Install dependencies
        working-directory: packages/test
        run: npm ci

      - name: Run linting
        working-directory: packages/test
        run: npm run lint

      - name: Type checking
        working-directory: packages/test
        run: npm run typecheck

      - name: Check build
        working-directory: packages/test
        run: npm run build

  # ðŸ§ª Test Suite
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16, 18, 20]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'packages/test/package-lock.json'

      - name: Install dependencies
        working-directory: packages/test
        run: npm ci

      - name: Run core tests
        working-directory: packages/test
        run: npm run test:core

      - name: Run all tests
        working-directory: packages/test
        run: npm test

  # ðŸŒ Browser Testing
  browser-test:
    name: Browser Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'packages/test/package-lock.json'

      - name: Install dependencies
        working-directory: packages/test
        run: npm ci

      - name: Install Playwright browsers
        working-directory: packages/test
        run: npx playwright install --with-deps

      - name: Run browser tests
        working-directory: packages/test
        run: npm run test:browser

  # ðŸ“Š Coverage Report
  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'packages/test/package-lock.json'

      - name: Install dependencies
        working-directory: packages/test
        run: npm ci

      - name: Generate coverage
        working-directory: packages/test
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          directory: packages/test/coverage
          flags: unittests
          name: @allystudio/test

  # ðŸ” Security Audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'packages/test/package-lock.json'

      - name: Run security audit
        working-directory: packages/test
        run: npm audit --audit-level=moderate

  # ðŸ“¦ Build Verification
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [quality, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'packages/test/package-lock.json'

      - name: Install dependencies
        working-directory: packages/test
        run: npm ci

      - name: Build package
        working-directory: packages/test
        run: npm run build

      - name: Verify build output
        working-directory: packages/test
        run: |
          # Check that required files exist
          test -f dist/index.js
          test -f dist/index.d.ts
          test -f dist/index.js.map

          # Check bundle size (should be around 31KB)
          SIZE=$(stat -f%z dist/index.js 2>/dev/null || stat -c%s dist/index.js)
          echo "Bundle size: $SIZE bytes"

          # Fail if bundle is significantly larger than expected (40KB threshold)
          if [ $SIZE -gt 40960 ]; then
            echo "âŒ Bundle size too large: $SIZE bytes (threshold: 40KB)"
            exit 1
          else
            echo "âœ… Bundle size OK: $SIZE bytes"
          fi

      - name: Test package installation
        working-directory: packages/test
        run: |
          # Pack the package
          npm pack

          # Create test directory
          mkdir -p /tmp/test-install
          cd /tmp/test-install

          # Install the packed package
          npm init -y
          npm install $GITHUB_WORKSPACE/packages/test/*.tgz

          # Test basic import
          node -e "
            const { describe, test, expect } = require('@allystudio/test');
            console.log('âœ… Package imports successfully');
            console.log('Available exports:', Object.keys(require('@allystudio/test')));
          "

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: packages/test/dist/
          retention-days: 7

  # ðŸš€ NPM Publishing
  publish:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: [quality, test, browser-test, security, build]
    if: github.event_name == 'release' && github.event.action == 'published'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: ${{ env.REGISTRY_URL }}
          cache: 'npm'
          cache-dependency-path: 'packages/test/package-lock.json'

      - name: Install dependencies
        working-directory: packages/test
        run: npm ci

      - name: Build package
        working-directory: packages/test
        run: npm run build

      - name: Publish to NPM
        working-directory: packages/test
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Get version from package.json
          VERSION=$(node -p "require('./package.json').version")
          echo "Publishing version: $VERSION"

          # Determine if this is a prerelease
          if [[ $VERSION == *"alpha"* || $VERSION == *"beta"* || $VERSION == *"rc"* ]]; then
            echo "Publishing as prerelease..."
            npm publish --tag next
          else
            echo "Publishing as latest..."
            npm publish
          fi

      - name: Create GitHub Release Assets
        working-directory: packages/test
        run: |
          # Create release archive
          tar -czf allystudio-test-${{ github.event.release.tag_name }}.tar.gz dist/

          # Upload to release
          gh release upload ${{ github.event.release.tag_name }} \
            allystudio-test-${{ github.event.release.tag_name }}.tar.gz \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ðŸ“ˆ Performance Monitoring
  performance:
    name: Performance Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'packages/test/package-lock.json'

      - name: Install dependencies
        working-directory: packages/test
        run: npm ci

      - name: Run benchmarks
        working-directory: packages/test
        run: npm run benchmark

      - name: Bundle size analysis
        working-directory: packages/test
        run: |
          npm run build

          echo "## ðŸ“Š Bundle Analysis" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY

          for file in dist/*; do
            if [ -f "$file" ]; then
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
              echo "| $(basename $file) | ${size} bytes |" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # ðŸ”„ Auto-update Dependencies (scheduled)
  dependency-update:
    name: Dependency Update
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'packages/test/package-lock.json'

      - name: Update dependencies
        working-directory: packages/test
        run: |
          npm update
          npm audit fix --audit-level=moderate

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): update dependencies'
          title: 'chore(deps): update dependencies'
          body: |
            Automated dependency update

            - Updated npm dependencies to latest versions
            - Applied security fixes

            Please review the changes and ensure all tests pass.
          branch: chore/dependency-updates
          path: packages/test
